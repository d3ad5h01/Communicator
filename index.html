<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0">
    <title>Main App</title>
    <link rel="stylesheet"
          type="text/css"
          href="./style.css">
</head>

<body>
    <div class="root-container flexRow centerRow flexGap" id="root-box">
        <div class="content-container flexCol centerCol border1B borderRadius padding10 width50vw" id="content-box">
            <div class="content-header-container flexRow  padding10" id="content-header-box">
                <input class="textarea1" name="myText" id="number-area" rows="1" placeholder="Number to call.." maxlength="400"></input>
                </br>
                <button id="dial-button"  class="button-6 backgroundGreen">DIAL</button>
            </div>    
            <div class="content-body-container border1B padding10 maxWidth" id="content-body-box">
                <h2>Calls</h2>
            </div>
        </div>
        <div class="sidebar-container flexCol centerCol" id="sidebar-box">
            <div id="messages">
                <h3>Messages</h3>
            </div>
            </br>
            <form>
                <textarea name="myText"
                          id="message-area"
                          rows="1"
                          placeholder="Type Message here..."
                          ></textarea>
            </form>
            </br>
            <button id="send-message"
                    class="button-6 backgroundWhite">Send to Child</button>
            </br>
        </div>
    </div>


    <script>

        let popup_win,communication = [],isPopupActive =0,call_object;


        //session restore 
        if(sessionStorage.getItem('is_popup_active')!=null)
            isPopupActive = sessionStorage.getItem('is_popup_active');
        else{
            sessionStorage.setItem('is_popup_active',0);
        }



        window.onbeforeunload = (event) => {
           sendMessage({header:'reload_parent',message:""});
           return "";
        };

        const dialButton = document.getElementById("dial-button");

        //On click of dial button , opening popup and adding dialed number in its dial-input
        dialButton.onclick = () => {
            console.log('Event: Dial Button Clicked');
            console.log(isPopupActive);
            if(isPopupActive!=0)
                return;
            isPopupActive=1;
            sessionStorage.setItem('is_popup_active',1);
            
            popup_win = open('./dialer/popup.html', 'popup',"left=100, top=100, width=426px, height=653px");
            console.log(popup_win);   
            
            call_object = createCallObject({to: document.getElementById('number-area').value});
            handleDialStart(call_object)

            sendMessage({header:'call_object',message: call_object});

            setTimeout(() => {
                console.log('SENDING NO');
                popup_win.document.getElementById('dialpad-input').value = document.getElementById('number-area').value;
            }, 2000);
            
           

        };


        function addmessageLocally(message){
            console.log(message);
            communication.push(message);
            document.getElementById('messages').innerHTML += ` <div class='maxWidth border1B padding10' '>${message}</div>`;
        }
       
        /*
            Send Message

            popup_win is address of popup window
            We can access its function so,

            we access its recieveMessage function and use it to share message.

        */
        function sendMessage(ack) {
            // sending to tab
            if(!isPopupActive)
                return;
            popup_win.recieveMessage(ack);

            // local updating
            addmessageLocally('Parent#'+ack.header+"#"+ack.message);
        }

        function handleClose(){
            console.log("handleClose enabled");
            popup_win.close();
            isPopupActive = 0;
            sessionStorage.setItem('is_popup_active',0);
            popup_win = null;

            console.log("Popup activeness"+isPopupActive);
            
        }

        /*
            recieve message 

            If we get "ended" => This means call ended so close popup window
            
        */
        function recieveMessage(ack) {
            if (ack.header == 'call_ended'){
                call_object.status = ack.header;
                updateCallObject();
               handleClose();
            }
            else if(ack.header == 'end_popup'){
                call_object.status = 'CALL_CANCALLED';
                updateCallObject();
                handleClose();
            }
            else if(ack.header == 'call_started'){
                call_object.status = ack.header;
                updateCallObject();
            }
            else if(ack.header == 'communicate'){

            }
            else if(ack.header == 'call_object'){
                call_object = ack.object;
                updateCallObject();
            }
            addmessageLocally('Dialer#'+ack.header+"#"+ack.message);
            // local  updating
        }


        //Send message button handeling
        document.getElementById('send-message').addEventListener('click', () => {
            sendMessage({header:'communicate',message: document.getElementById('message-area').value});
            document.getElementById('message-area').value = '';
        })


        // Variable Exchange

        function setParentVariable(parentVar){
            console.log("Parent is: ");
            parent = parentVar;
            console.log(parent);
        }

        function getParentVariable(){
            return parent;
        }

        function sendParentVariable(){
            popup_win.setParentVariable(parent);
        }

        function setPopUpVariable(childVar){
            console.log("Pop window recived is ");
            popup_win = childVar;
            console.log(popup_win);
        }

        function getPopUpVariable(){
            return popup_win;
        }

        function sendPopUpVariable(){
            popup_win.setPopUpVariable(popup_win);
        }

        
        // Irrelevent style handeling logic
        const txt = document.querySelector('#message-area');
        function setNewSize() {
            this.style.height = "1px";
            this.style.height = this.scrollHeight + "px";
        }
        txt.addEventListener('keyup', setNewSize);



        // call object
        // id, duration, to , started 

        function updateCallObject(){
            let ack = call_object;
            document.getElementById(`${call_object.id}`).innerHTML = `<div class='maxWidth border1B padding10' id='${ack.id}'> ID: ${ack.to} </br> TO: ${ack.id} </br> STATUS: ${ack.status} </br> DURATION: ${ack.duration} </div>`;
        }   

        function addInCallBox(ack){
            document.getElementById('content-body-box').innerHTML+= `<div class='maxWidth border1B padding10' id='${ack.id}'> ID: ${ack.to} </br> TO: ${ack.id} </br> STATUS: ${ack.status} </br> DURATION: ${ack.duration} </div>`;
        }
        function handleDialStart(ack){
            addInCallBox(ack);
        }

        function createCallObject(ack){
            return {id: callIdCreate(), duration: "NA" , to:ack.to, started: new Date(), status:'DIALER_STARTED'};
        }


        function callIdCreate(){
            return Number(new Date());
        }
/*
message Exchange Object
        header:
        object:
        message:
*/

    </script>
</body>

</html>



